name: Deploy DAGs to Cloud Composer

on: push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Debug configurationfdsljfsodifjweowef
        run : gcloud storage buckets list --project=goorm-bomnet

      - name: Debug Google Cloud Auth
        run: |
          echo "üîç ÌòÑÏû¨ Ïù∏Ï¶ùÎêú Í≥ÑÏ†ï Î™©Î°ù:"
          gcloud auth list
          echo "üîç ÌòÑÏû¨ gcloud ÏÑ§Ï†ïÎêú ÌîÑÎ°úÏ†ùÌä∏:"
          gcloud config get-value project

      - name: Check GCS Bucket IAM Policy
        run: |
          echo "üîç Î≤ÑÌÇ∑ IAM Ï†ïÏ±Ö ÌôïÏù∏:"
          gcloud storage buckets get-iam-policy gs://asia-northeast3-goorm-envir-f14a327b-bucket
      - name: Check Current User GCS Permissions
        run: |
          echo "üîç ÌòÑÏû¨ Ïù∏Ï¶ùÎêú Í≥ÑÏ†ïÏù¥ GCSÏóêÏÑú Ïñ¥Îñ§ Í∂åÌïúÏùÑ Í∞ÄÏßÄÍ≥† ÏûàÎäîÏßÄ ÌôïÏù∏:"
          gcloud storage buckets get-iam-policy gs://asia-northeast3-goorm-envir-f14a327b-bucket --format=json
      - name: Test GCS Access
        run: |
          echo "üîç ÌòÑÏû¨ Í≥ÑÏ†ïÏúºÎ°ú Î≤ÑÌÇ∑ ÎÇ¥Î∂Ä ÌååÏùº Ï°∞Ìöå ÌÖåÏä§Ìä∏:"
          gcloud storage ls gs://asia-northeast3-goorm-envir-f14a327b-bucket/dags

      - name: Set up environment variables
        run: |
          echo "PROJECT_ID=${{ vars.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "BUCKET_NAME=${{ vars.GCS_BUCKET_NAME }}" >> $GITHUB_ENV

      - name: Debug GitHub Actions Variables
        run: |
          echo "üîç GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}"
          echo "üîç GCS_BUCKET_NAME: ${{ vars.GCS_BUCKET_NAME }}"
      - name: Debug Environment Variables Before Upload
        run: |
          echo "üîç Using BUCKET_NAME: $BUCKET_NAME"


      - name: Upload DAGs to GCS (Use gcloud storage instead of gsutil)
        run: |
          gcloud storage rsync --recursive airflow-local/dags gs://asia-northeast3-goorm-envir-f14a327b-bucket/dags