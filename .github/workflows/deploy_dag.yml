name: Deploy DAGs to Cloud Composer

on: push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Debug configurationfdsljfsodifjweowef
        run : gcloud storage buckets list --project=goorm-bomnet

      - name: Debug Google Cloud Auth
        run: |
          echo "ğŸ” í˜„ì¬ ì¸ì¦ëœ ê³„ì • ëª©ë¡:"
          gcloud auth list
          echo "ğŸ” í˜„ì¬ gcloud ì„¤ì •ëœ í”„ë¡œì íŠ¸:"
          gcloud config get-value project

      - name: Check GCS Bucket IAM Policy
        run: |
          echo "ğŸ” ë²„í‚· IAM ì •ì±… í™•ì¸:"
          gcloud storage buckets get-iam-policy gs://asia-northeast3-goorm-envir-f14a327b-bucket
      - name: Check Current User GCS Permissions
        run: |
          echo "ğŸ” í˜„ì¬ ì¸ì¦ëœ ê³„ì •ì´ GCSì—ì„œ ì–´ë–¤ ê¶Œí•œì„ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸:"
          gcloud storage buckets get-iam-policy gs://asia-northeast3-goorm-envir-f14a327b-bucket --format=json
      - name: Test GCS Access
        run: |
          echo "ğŸ” í˜„ì¬ ê³„ì •ìœ¼ë¡œ ë²„í‚· ë‚´ë¶€ íŒŒì¼ ì¡°íšŒ í…ŒìŠ¤íŠ¸:"
          gcloud storage ls gs://asia-northeast3-goorm-envir-f14a327b-bucket/dags

      - name: Set up environment variables
        run: |
          echo "PROJECT_ID=${{ vars.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "BUCKET_NAME=${{ vars.GCS_BUCKET_NAME }}" >> $GITHUB_ENV

      - name: Debug GitHub Actions Variables
        run: |
          echo "ğŸ” GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}"
          echo "ğŸ” GCS_BUCKET_NAME: ${{ vars.GCS_BUCKET_NAME }}"
      - name: Debug Environment Variables Before Upload
        run: |
          ğŸ” Using BUCKET_NAME: asia-northeast3-goorm-envir-f14a327b-bucket


      - name: Upload DAGs to GCS (Use gcloud storage instead of gsutil)
        run: |
          gcloud storage rsync --recursive airflow-local/dags gs://asia-northeast3-goorm-envir-f14a327b-bucket/dags
