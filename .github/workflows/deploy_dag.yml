name: Deploy DAGs to Cloud Composer

on: push

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Debug configurationfdsljfsodifjweowef
        run : gcloud storage buckets list --project=goorm-bomnet

      - name: Debug Google Cloud Auth
        run: |
          echo "ðŸ” í˜„ìž¬ ì¸ì¦ëœ ê³„ì • ëª©ë¡:"
          gcloud auth list
          echo "ðŸ” í˜„ìž¬ gcloud ì„¤ì •ëœ í”„ë¡œì íŠ¸:"
          gcloud config get-value project

      - name: Check GCS Bucket IAM Policy
        run: |
          echo "ðŸ” ë²„í‚· IAM ì •ì±… í™•ì¸:"
          gcloud storage buckets gs://get-iam-policy asia-northeast3-goorm-envir-f14a327b-bucket
      - name: Check Current User GCS Permissions
        run: |
          echo "ðŸ” í˜„ìž¬ ì¸ì¦ëœ ê³„ì •ì´ GCSì—ì„œ ì–´ë–¤ ê¶Œí•œì„ ê°€ì§€ê³  ìžˆëŠ”ì§€ í™•ì¸:"
          gcloud storage buckets get-iam-policy gs://asia-northeast3-goorm-envir-f14a327b-bucket --format=json
      - name: Test GCS Access
        run: |
          echo "ðŸ” í˜„ìž¬ ê³„ì •ìœ¼ë¡œ ë²„í‚· ë‚´ë¶€ íŒŒì¼ ì¡°íšŒ í…ŒìŠ¤íŠ¸:"
          gcloud storage ls gs://asia-northeast3-goorm-envir-f14a327b-bucket/

      - name: Set up environment variables
        run: |
          echo "PROJECT_ID=${{ vars.GCP_PROJECT_ID }}" >> $GITHUB_ENV
          echo "BUCKET_NAME=${{ vars.GCS_BUCKET_NAME }}" >> $GITHUB_ENV

      - name: Upload DAGs to GCS (Use gcloud storage instead of gsutil)
        run: |
          gcloud storage rsync --recursive airflow-local/dags gs://$BUCKET_NAME/dags
